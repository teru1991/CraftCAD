# DETERMINISM

最終更新: 2026-02-28  
ステータス: SSOT（Single Source of Truth）草案

## 1. 約束

CraftCAD は **同一入力に対して同一結果** を返す（決定性）ことをプロダクト要件とする。

## 2. 決定性の定義

- 入力が同じなら、以下が一致すること
  - Core 計算結果
  - `.diycad` 出力バイト列（同一バージョン・同一設定下）
  - 派生メタデータ（ID 生成規則を含む）

## 3. 実装規約

### 3.1 seed 固定

- 疑似乱数を使う場合は seed を明示し、入力から導出可能にする
- seed 非指定の乱数 API を禁止する

### 3.2 順序固定

- 集合/マップ走査順に依存しない
- シリアライズ時はキー順序を固定化する
- 並列処理結果は安定ソートしてから確定する

### 3.3 丸め規則

- 浮動小数計算で丸め位置（桁）と丸めモードを明示する
- 表示用丸めと保存用丸めを分離し、混同しない

### 3.4 ε（イプシロン）

- 幾何判定は共通 ε を利用する
- ε の定義は Core の単一箇所で管理する
- 文脈ごとの ε の派生規則を定義し、マジックナンバーを禁止する

## 4. 決定性テスト方針

- ゴールデンテスト
  - 同入力から生成した `.diycad` バイト列を比較
- リピートテスト
  - 同一処理を複数回実行し完全一致を確認
- クロス環境テスト（将来）
  - OS/CPU 差異があっても論理結果が一致することを確認
- 変更時ルール
  - 意図的変更でゴールデン更新が必要な場合、理由を `DECISION_LOG.md` に記載
